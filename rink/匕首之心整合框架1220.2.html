<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ•é¦–ä¹‹å¿ƒ Â· æˆ˜å½¹æ„ç­‘å™¨ V2.11</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Oswald:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* æµ…è‰²æ¨¡å¼ */
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --text-main: #2d3748;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --accent-color: #e05d44;
            --accent-hover: #c54e36;
            --track-empty: #ffffff;
            --track-border: #cbd5e0;
            --track-fill: #e05d44;
            --note-bg: #fffbeb;
            --note-border: #fcd34d;
            --favorite-color: #e53e3e;
            --nav-width: 250px;
            --right-panel-width: 280px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        [data-theme="dark"] {
            /* æ·±è‰²æ¨¡å¼ */
            --bg-body: #111827;
            --bg-card: #1f2937;
            --bg-sidebar: #1f2937;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --track-empty: #374151;
            --track-border: #4b5563;
            --track-fill: #e05d44;
            --note-bg: #422006;
            --note-border: #78350f;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s; }

        /* --- åŠ è½½é®ç½© --- */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- é¡¶éƒ¨å¯¼èˆª --- */
        .app-header { background: var(--bg-card); border-bottom: 1px solid var(--border-color); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; height: 64px; flex-shrink: 0; z-index: 50; box-shadow: var(--shadow-sm); }
        .logo-group { display: flex; align-items: center; gap: 12px; }
        .logo { font-family: 'Oswald', sans-serif; font-size: 1.5rem; font-weight: 700; color: var(--accent-color); display:flex; align-items:center; gap:8px; line-height: 1; }
        .signature { font-size: 0.8rem; color: var(--text-muted); font-family: 'Roboto', sans-serif; opacity: 0.8; letter-spacing: 0.5px; border-left: 2px solid var(--border-color); padding-left: 12px; height: 24px; display: flex; align-items: center; white-space: nowrap; }
        .nav-tabs { display: flex; gap: 8px; height: 100%; }
        .nav-item { display: flex; align-items: center; padding: 0 16px; cursor: pointer; color: var(--text-muted); font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; height: 100%; font-size: 0.95rem; }
        .nav-item:hover { color: var(--accent-color); background: rgba(0,0,0,0.02); }
        .nav-item.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .theme-toggle { cursor: pointer; padding: 0; border-radius: 50%; background: var(--track-empty); border: 1px solid var(--border-color); font-size: 1.1rem; display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; transition: 0.2s; }

        /* --- å¸ƒå±€å®¹å™¨ --- */
        .main-container { flex: 1; position: relative; overflow: hidden; display: flex; }
        .page { display: none; width: 100%; height: 100%; overflow-y: auto; padding: 24px; animation: fadeIn 0.25s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* --- é€šç”¨ç»„ä»¶ --- */
        .card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow-md); padding: 24px; margin-bottom: 24px; border: 1px solid var(--border-color); }
        .btn { background: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; }
        .btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); padding: 7px 14px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); background: var(--track-empty); }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .btn-text { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.9rem; padding: 4px 8px; }
        .btn-text:hover { color: var(--accent-color); }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        input, textarea, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-body); color: var(--text-main); font-family: inherit; transition: 0.2s; font-size: 0.95rem; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(224, 93, 68, 0.1); }
        
        /* --- 1. æ¦‚è§ˆé¡µ --- */
        .banner-wrapper { border-radius: var(--radius); overflow: hidden; margin-bottom: 20px; box-shadow: var(--shadow-md); background: var(--bg-card); border: 1px solid var(--border-color); position: relative; transition: all 0.3s ease; }
        .banner-img-container { width: 100%; height: 300px; background-color: var(--bg-body); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .banner-img { width: 100%; height: 100%; object-fit: cover; transform-origin: center center; }
        .banner-placeholder { text-align: center; color: var(--text-muted); }
        .banner-controls-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px 20px; background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); display: flex; justify-content: space-between; align-items: center; opacity: 0; transition: opacity 0.2s; }
        .banner-wrapper:hover .banner-controls-overlay { opacity: 1; }
        .banner-slider-group { display: flex; gap: 15px; align-items: center; }
        .banner-slider-group input[type=range] { width: 80px; height: 4px; padding: 0; margin: 0; background: #666; }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        .dash-header-input { font-size: 2rem; font-family: 'Oswald', sans-serif; border: none; border-bottom: 2px solid transparent; background: transparent; padding: 5px 0; font-weight: bold; color: var(--accent-color); width: 100%; transition: 0.2s; }
        .dash-header-input:focus { border-bottom-color: var(--accent-color); background: var(--bg-body); }

        /* --- 2. ç« èŠ‚é¡µ --- */
        .split-layout { display: grid; grid-template-columns: var(--nav-width) 1fr; gap: 0; height: 100%; border: 1px solid var(--border-color); border-radius: var(--radius); overflow: hidden; background: var(--bg-card); box-shadow: var(--shadow-md); }
        .toc-panel { border-right: 1px solid var(--border-color); padding: 15px; overflow-y: auto; background: var(--bg-body); }
        .toc-title { font-size: 0.8rem; font-weight: bold; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; padding-left: 5px; }
        .toc-item { padding: 10px 12px; border-radius: 6px; cursor: pointer; color: var(--text-muted); margin-bottom: 4px; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: 0.2s; }
        .toc-item:hover { background: rgba(0,0,0,0.05); color: var(--text-main); }
        .toc-item.active { background: white; color: var(--accent-color); font-weight: bold; box-shadow: var(--shadow-sm); border-left: 4px solid var(--accent-color); }
        [data-theme="dark"] .toc-item.active { background: var(--bg-card); }
        .session-content-area { padding: 30px; overflow-y: auto; background: var(--bg-card); }
        .content-display a { color: #e05d44; text-decoration: none; border-bottom: 1px dotted #e05d44; transition: 0.2s; }
        .content-display a:hover { background: rgba(224, 93, 68, 0.1); border-bottom-style: solid; }
        .content-display { white-space: pre-wrap; line-height: 1.6; word-break: break-all; }

        /* --- 3. é­é‡é¡µ --- */
        .enc-layout { display: grid; grid-template-columns: var(--nav-width) 1fr var(--right-panel-width); gap: 24px; height: 100%; }
        .enc-toc-container { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); overflow: hidden; box-shadow: var(--shadow-md); height: 100%; display: flex; flex-direction: column; }
        .enc-toc-list { flex: 1; overflow-y: auto; padding: 15px; }
        .enc-toc-footer { padding: 15px; border-top: 1px solid var(--border-color); background: var(--bg-body); }
        .btn-new-enc { width: 100%; background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); padding: 10px; border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-new-enc:hover { border-color: var(--accent-color); color: var(--accent-color); background: white; }
        .enc-main-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); height: 100%; display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--shadow-md); }
        .enc-header { padding: 30px 30px 0 30px; flex-shrink: 0; }
        .enc-body { flex: 1; overflow-y: auto; padding: 20px 30px; }
        .enc-title-input { font-size: 1.8rem; font-family: 'Oswald', sans-serif; border: none; background: transparent; padding: 0; font-weight: bold; color: var(--accent-color); width: 100%; margin-bottom: 15px; }
        .env-row { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 0.95rem; }
        .env-detail-btn { background: white; border: 1px solid var(--border-color); color: var(--text-muted); padding: 5px 12px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .env-detail-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .note-wrapper { margin-bottom: 20px; }
        .note-toggle { font-size: 0.8rem; color: var(--text-muted); cursor: pointer; margin-bottom: 4px; display: inline-block; }
        .note-toggle:hover { color: var(--accent-color); text-decoration: underline; }
        .note-box { background: var(--note-bg); border: 1px solid var(--note-border); border-radius: 6px; padding: 15px; color: #78350f; font-size: 0.95rem; width: 100%; min-height: 60px; font-family: inherit; resize: vertical; display: none; }
        .note-box.visible { display: block; }
        .adv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .adv-card { background: #f8fafc; border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; position: relative; transition: 0.2s; }
        [data-theme="dark"] .adv-card { background: #2d3748; }
        .adv-card:hover { border-color: var(--accent-color); box-shadow: var(--shadow-sm); }
        .adv-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .adv-name { font-weight: 700; font-size: 1.05rem; font-family: 'Oswald', sans-serif; color: var(--text-main); }
        .detail-pill { display: inline-block; border: 1px solid var(--accent-color); color: var(--accent-color); border-radius: 12px; padding: 1px 8px; font-size: 0.75rem; cursor: pointer; margin-left: 8px; font-family: 'Roboto', sans-serif; font-weight: normal; background: white; }
        .detail-pill:hover { background: var(--accent-color); color: white; }
        .track-row { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .track-label { font-size: 0.8rem; font-weight: bold; color: var(--favorite-color); width: 45px; text-transform: uppercase; }
        .track-label.str { color: #4a5568; }
        [data-theme="dark"] .track-label.str { color: #a0aec0; }
        .track-boxes { display: flex; gap: 4px; flex-wrap: wrap; }
        .track-box { width: 20px; height: 20px; border: 2px solid var(--track-border); cursor: pointer; background: var(--track-empty); border-radius: 3px; }
        .track-box.checked { background: var(--track-fill); border-color: var(--track-fill); }
        .btn-remove-adv { position: absolute; top: 10px; right: 10px; color: var(--favorite-color); background: none; border: none; font-size: 1.2rem; cursor: pointer; line-height: 1; opacity: 0.5; }
        .btn-remove-adv:hover { opacity: 1; }
        
        /* å€’è®¡æ—¶ & è®¡æ•°å™¨ æ ·å¼ */
        .mechanics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .mech-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; position: relative; transition:0.2s; }
        .mech-card:hover { border-color: var(--accent-color); box-shadow: var(--shadow-sm); }
        
        /* å¸ƒå±€ä¼˜åŒ– V2.11: Header */
        .mech-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed var(--border-color); gap: 10px; }
        .mech-title { flex: 1; min-width: 0; }
        .mech-title input { border: none; background: transparent; font-weight: bold; font-size: 1.1rem; width: 100%; min-width: 120px; font-family: 'Oswald'; color: var(--text-main); }
        .mech-title input:focus { border-bottom: 1px solid var(--accent-color); }
        .mech-options { display: flex; align-items: center; gap: 5px; flex-shrink: 0; font-size: 0.75rem; color: #666; }
        
        .mech-body { flex: 1; display: flex; align-items: center; justify-content: center; margin: 15px 0; }
        
        /* Max Input Style (V2.10) */
        .mech-max-input { width: 35px; border: none; border-bottom: 1px solid var(--border-color); background: transparent; text-align: center; font-size: 0.75rem; color: var(--text-muted); font-weight: bold; }
        .mech-max-input:focus { outline: none; border-color: var(--accent-color); color: var(--accent-color); }

        /* å€’è®¡æ—¶éª°å­ */
        .countdown-die { width: 64px; height: 64px; background: var(--accent-color); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; align-items: center; justify-content: center; font-size: 2.2rem; color: white; font-family: 'Oswald'; font-weight: bold; cursor: pointer; transition: 0.2s; user-select: none; }
        .countdown-die.zero { background: #e53e3e; animation: pulse 1s infinite; }
        .countdown-die:active { transform: scale(0.95); }
        
        /* æ–¹æ ¼æ¨¡å¼ */
        .countdown-boxes { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .countdown-box { width: 20px; height: 20px; border: 2px solid var(--accent-color); background: var(--track-empty); cursor: pointer; border-radius: 2px; }
        .countdown-box.filled { background: var(--accent-color); }

        /* è®¡æ•°å™¨åœ†ç‚¹ */
        .counter-dots { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }
        .counter-dot { width: 16px; height: 16px; border-radius: 50%; background: var(--track-border); cursor: pointer; transition: 0.2s; }
        .counter-dot.active { background: #3182ce; box-shadow: 0 0 5px rgba(49, 130, 206, 0.5); }
        .counter-number { font-size: 2rem; font-weight: bold; font-family: 'Oswald'; }

        /* å™äº‹å­—æ®µè¾“å…¥æ¡† */
        .mech-narrative { margin-top: 10px; font-size: 0.85rem; }
        .mech-input-group { display: flex; align-items: baseline; margin-bottom: 4px; }
        .mech-label { width: 40px; font-weight: bold; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
        .mech-input { flex: 1; border: none; border-bottom: 1px solid var(--border-color); background: transparent; padding: 2px 5px; font-size: 0.9rem; color: var(--text-main); transition: 0.2s; }
        .mech-input:focus { border-bottom-color: var(--accent-color); outline: none; background: rgba(0,0,0,0.02); }

        .btn-ctrl { background: white; border: 1px solid var(--border-color); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer; color: var(--text-main); font-weight: bold; }
        .btn-ctrl:hover { border-color: var(--text-muted); }

        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }

        /* é€ŸæŸ¥ & é’‰é€‰ */
        .quick-ref-area { border-top: 2px dashed var(--border-color); margin-top: 30px; padding-top: 20px; }
        .quick-ref-title { font-family: 'Oswald', sans-serif; color: var(--text-muted); font-size: 1.1rem; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .stat-block { font-family: 'Crimson Text', serif; font-size: 1rem; color: var(--text-main); background: var(--bg-card); padding: 15px 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent-color); border: 1px solid var(--border-color); border-left-width: 4px; }
        .sb-header { font-family: 'Oswald', sans-serif; font-weight: bold; font-size: 1.15rem; color: var(--accent-color); display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding-bottom: 6px; margin-bottom: 8px; }
        .sb-meta { font-style: italic; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px; }
        .sb-row { margin-bottom: 4px; line-height: 1.4; }
        .sb-label { font-weight: bold; color: var(--text-main); font-variant: small-caps; }
        .sb-tactics { margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.03); border-radius: 4px; border-left: 2px solid var(--text-muted); font-style: italic; color: #555; }
        [data-theme="dark"] .sb-tactics { background: rgba(255,255,255,0.05); color: #ccc; }

        .pinned-panel { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); padding: 15px; overflow-y: auto; box-shadow: var(--shadow-md); height: 100%; }
        .pinned-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; margin-bottom: 5px; border: 1px solid transparent; }
        .pinned-item:hover { background: var(--bg-body); border-color: var(--border-color); }
        .pinned-img { width: 36px; height: 36px; border-radius: 4px; object-fit: cover; background: var(--bg-body); border: 1px solid var(--border-color); }

        /* --- 4. å¡ç‰‡åº“ --- */
        .search-bar-wrapper { position: relative; flex: 1; max-width: 400px; }
        .search-bar-wrapper input { padding-left: 36px; border-radius: 20px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); opacity: 0.7; }
        .lib-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .lib-card { position: relative; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border-color); background: var(--bg-card); border-radius: 10px; overflow: hidden; }
        .lib-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--accent-color); }
        .lib-img { height: 120px; background: var(--bg-body); display: flex; align-items: center; justify-content: center; overflow: hidden; border-bottom: 1px solid var(--border-color); }
        .lib-img img { width: 100%; height: 100%; object-fit: cover; }
        .lib-fav-icon { position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.95); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #ccc; z-index: 2; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .lib-fav-icon.active { color: var(--favorite-color); }
        .lib-fav-icon:hover { transform: scale(1.1); color: var(--favorite-color); }

        /* ä¾§è¾¹è¯¦æƒ… */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(3px); }
        .detail-sidebar { position: fixed; top: 0; right: -650px; width: 650px; height: 100%; background: var(--bg-sidebar); box-shadow: -10px 0 30px rgba(0,0,0,0.3); z-index: 101; transition: right 0.3s cubic-bezier(0.2, 1, 0.3, 1); display: flex; flex-direction: column; }
        .detail-sidebar.active { right: 0; }
        .sidebar-overlay.active { display: block; opacity: 1; }

        @media (max-width: 1200px) { .enc-layout { grid-template-columns: 220px 1fr; } .pinned-panel { display: none; } }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } .enc-layout { grid-template-columns: 1fr; } .enc-toc-container { display: none; } }
    </style>
</head>
<body>

    <!-- åŠ è½½é®ç½© -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div style="font-family:'Oswald',sans-serif; color:var(--text-muted); letter-spacing:1px;">LOADING DATA...</div>
    </div>

    <!-- é¡¶éƒ¨ -->
    <header class="app-header">
        <div class="logo-group">
            <div class="logo">
                <span style="font-size:1.6rem;">ğŸ—¡ï¸</span> 
                DAGGERHEART
            </div>
            <div class="signature">| åŒ•é¦–ä¹‹å¿ƒæ•´åˆæ¡†æ¶ | Rink_CX | V2.11_25/12 |</div>
        </div>
        <nav class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('info')">æ¦‚è§ˆ</div>
            <div class="nav-item" onclick="switchTab('sessions')">ç« èŠ‚</div>
            <div class="nav-item" onclick="switchTab('encounters')">é­é‡</div>
            <div class="nav-item" onclick="switchTab('cards')">å¡ç‰‡</div>
        </nav>
        <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢æ—¥å¤œæ¨¡å¼">ğŸŒ—</button>
    </header>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">

        <!-- 1. æ¦‚è§ˆ -->
        <div id="page-info" class="page active">
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:10px; align-items:center;">
                <span id="save-status" style="font-size:0.8rem; color:var(--text-muted); margin-right:10px;"></span>
                <button class="btn-text" onclick="copyAnnouncement()">ğŸ“‹ å¤åˆ¶æ–‡å­—å…¬å‘Š</button>
                <button class="btn-text" onclick="toggleBannerVisibility()" id="banner-toggle-btn">ğŸ‘ï¸ éšè—æ¨ªå¹…</button>
                <button class="btn" onclick="saveData()">ğŸ’¾ å¼ºåˆ¶ä¿å­˜</button>
            </div>

            <!-- æ¨ªå¹…åŒºåŸŸ -->
            <div class="banner-wrapper" id="banner-area">
                <div class="banner-img-container">
                    <img id="banner-img-el" class="banner-img" src="" alt="Banner" style="display:none;">
                    <div id="banner-placeholder">
                        <p style="font-size:2rem; margin-bottom:10px;">ğŸ–¼ï¸</p>
                        <button class="btn-outline" onclick="triggerBannerUpload()">ä¸Šä¼ æˆ˜å½¹å°é¢ (æ”¯æŒå¤§å›¾)</button>
                        <input type="file" id="banner-upload-input" accept="image/*" style="display:none">
                    </div>
                </div>
                <div class="banner-controls-overlay">
                    <div class="banner-slider-group">
                        <label>X</label> <input type="range" min="0" max="100" value="50" oninput="updateBannerConfig('posX', this.value)">
                        <label>Y</label> <input type="range" min="0" max="100" value="50" oninput="updateBannerConfig('posY', this.value)">
                        <label>ğŸ”</label> <input type="range" min="100" max="300" value="100" oninput="updateBannerConfig('scale', this.value)">
                    </div>
                    <button class="btn-sm btn-outline" style="color:white; border-color:white; background:rgba(255,255,255,0.1);" onclick="triggerBannerUpload()">æ›´æ¢å›¾ç‰‡</button>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <div class="form-group" style="margin-bottom:20px;">
                        <label>æˆ˜å½¹æ ‡é¢˜ (æ¨¡ç»„å)</label>
                        <input type="text" id="info-name" class="dash-header-input" placeholder="è¾“å…¥æˆ˜å½¹åç§°...">
                    </div>
                    <div class="form-group"><label>æˆ˜å½¹æ¡†æ¶</label><input type="text" id="info-framework" placeholder="ä¾‹å¦‚ï¼šå®˜æ–¹æ¨¡ç»„ / å¼€æ”¾æ²™ç›’..."></div>
                    <div class="form-group">
                        <label>æœ¬å›¢æ¦‚å¿µ (High Concept)</label>
                        <textarea id="info-concept" placeholder="ä¸€å¥è¯æ¦‚æ‹¬æ ¸å¿ƒè®¾å®šã€èƒŒæ™¯..." style="min-height:80px;"></textarea>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
                        <div class="form-group">
                            <label>æœ¬å›¢åŸºè°ƒ</label>
                            <textarea id="info-tone" placeholder="æƒ…æ„ŸåŸºè°ƒ..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>æœ¬å›¢ä¸»é¢˜</label>
                            <textarea id="info-themes" placeholder="Focus & Avoid..."></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>GM ç›®æ ‡</label>
                        <textarea id="info-goals" placeholder="æ¸¸æˆåˆ›æ„ä¸ç¤¾äº¤æœŸæœ›..." style="min-height:60px;"></textarea>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin:0 0 20px 0; font-family:'Oswald',sans-serif; color:var(--text-muted); border-bottom:1px solid var(--border-color); padding-bottom:10px;">æˆ˜å½¹å‚æ•°</h3>
                    <div class="form-group"><label>ä¸»æŒäººä¸QQå·</label><input type="text" id="info-gm" placeholder="è”ç³»æ–¹å¼..."></div>
                    <div class="form-group"><label>èµ„æº (è§„å®šèŒƒå›´)</label><input type="text" id="info-resources" placeholder="æ ¸å¿ƒä¹¦ v1.5..."></div>
                    <div class="form-group"><label>å›¢ç±»å‹ä¸å¹³å°</label><input type="text" id="info-platform" placeholder="FoundryVTT / è¯­éŸ³"></div>
                    <div class="form-group"><label>ç©å®¶äººæ•°</label><input type="number" id="info-players" placeholder="PC æ•°é‡"></div>
                    <div class="form-group"><label>å¼€å›¢æ—¶é—´</label><input type="text" id="info-time" placeholder="ä¾‹å¦‚ï¼šæ¯å‘¨äº” 20:00"></div>
                </div>
            </div>
        </div>

        <!-- 2. ç« èŠ‚ -->
        <div id="page-sessions" class="page">
            <div class="split-layout">
                <div class="toc-panel" id="session-toc"></div>
                <div class="session-content-area" id="session-container"></div>
            </div>
            <button class="btn" style="position:fixed; bottom:40px; right:40px; box-shadow:0 6px 20px rgba(0,0,0,0.3); z-index:10; border-radius:30px; padding:12px 24px;" onclick="addSession()">+ æ–°å»ºç« èŠ‚</button>
        </div>

        <!-- 3. é­é‡ -->
        <div id="page-encounters" class="page" style="padding:0;">
            <div class="enc-layout">
                <div class="enc-toc-container">
                    <div class="toc-title" style="padding: 15px 15px 0 15px;">é­é‡åˆ—è¡¨</div>
                    <div id="encounter-toc" class="enc-toc-list"></div>
                    <div class="enc-toc-footer">
                        <button class="btn-new-enc" onclick="addEncounter()">+ æ–°å»ºé­é‡</button>
                    </div>
                </div>
                <div class="enc-main-card">
                    <div id="encounter-detail-wrapper" style="height:100%; display:flex; flex-direction:column;">
                        <div style="text-align:center; padding:50px; color:var(--text-muted); margin-top:100px;">è¯·ä»å·¦ä¾§é€‰æ‹©æˆ–æ–°å»ºä¸€ä¸ªé­é‡</div>
                    </div>
                </div>
                <div class="pinned-panel">
                    <div class="toc-title">ğŸ“Œ èµ„æºé’‰æ¿</div>
                    <div id="pinned-cards-container" style="margin-top:10px;"></div>
                </div>
            </div>
        </div>

        <!-- 4. å¡ç‰‡ -->
        <div id="page-cards" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h2 style="margin:0; font-family:'Oswald',sans-serif;">å¡ç‰Œåº“</h2>
                <div style="display:flex; gap:15px; align-items:center; width:60%;">
                    <div class="search-bar-wrapper"><span class="search-icon">ğŸ”</span><input type="text" placeholder="æœç´¢å¡ç‰Œåç§°..." oninput="renderLibrary()" id="lib-search"></div>
                    <button class="btn-outline" onclick="document.getElementById('json-import').click()">ğŸ“‚ å¯¼å…¥ JSON</button>
                    <input type="file" id="json-import" accept=".json" style="display:none;" onchange="importJSON(this)">
                </div>
            </div>
            <div id="library-content"></div>
        </div>

    </div>

    <!-- ä¾§è¾¹è¯¦æƒ…æ  -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>
    <div class="detail-sidebar" id="detail-sidebar">
        <div style="padding:15px 25px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; background:var(--bg-card);">
            <h3 style="margin:0;">å¡ç‰Œè¯¦æƒ…</h3>
            <button class="btn-text" onclick="closeSidebar()">âœ• å…³é—­</button>
        </div>
        <div id="ds-content" style="padding:25px; overflow-y:auto; flex:1;"></div>
    </div>

    <script>
        // ==========================================
        //  IndexedDB Wrapper
        // ==========================================
        class SimpleDB {
            constructor(dbName, storeName) { this.dbName = dbName; this.storeName = storeName; this.db = null; }
            async open() {
                if (this.db) return this.db;
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.dbName, 1);
                    req.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(this.storeName)) db.createObjectStore(this.storeName); };
                    req.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); };
                    req.onerror = (e) => reject('DB Error: ' + e.target.error);
                });
            }
            async get(key) { await this.open(); return new Promise((resolve, reject) => { const tx = this.db.transaction(this.storeName, 'readonly'); const store = tx.objectStore(this.storeName); const req = store.get(key); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); }
            async set(key, value) { await this.open(); return new Promise((resolve, reject) => { const tx = this.db.transaction(this.storeName, 'readwrite'); const store = tx.objectStore(this.storeName); const req = store.put(value, key); req.onsuccess = () => resolve(true); req.onerror = () => reject(req.error); }); }
        }

        const db = new SimpleDB('DaggerheartDB', 'CampaignStore');
        const DB_KEY = 'campaign_data_v2';
        
        let appData = {
            banner: { src: '', posX: 50, posY: 50, scale: 100, visible: true },
            info: {}, sessions: [], encounters: [], library: [] 
        };
        let currentEncounterId = null;
        let saveTimeout = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            const loader = document.getElementById('loading-screen');
            await loadData();
            document.getElementById('banner-upload-input').addEventListener('change', handleBannerUpload);
            renderAll();
            setTimeout(() => { loader.style.opacity = 0; setTimeout(() => loader.style.display = 'none', 500); }, 500);
        });

        // --- Data Logic ---
        async function saveData() {
            appData.info = {
                name: document.getElementById('info-name')?.value || appData.info.name,
                framework: document.getElementById('info-framework')?.value || appData.info.framework,
                concept: document.getElementById('info-concept')?.value || appData.info.concept,
                tone: document.getElementById('info-tone')?.value || appData.info.tone,
                themes: document.getElementById('info-themes')?.value || appData.info.themes,
                goals: document.getElementById('info-goals')?.value || appData.info.goals,
                gm: document.getElementById('info-gm')?.value || appData.info.gm,
                resources: document.getElementById('info-resources')?.value || appData.info.resources,
                platform: document.getElementById('info-platform')?.value || appData.info.platform,
                players: document.getElementById('info-players')?.value || appData.info.players,
                time: document.getElementById('info-time')?.value || appData.info.time
            };

            const status = document.getElementById('save-status');
            if(status) status.innerText = "ğŸ’¾ æ­£åœ¨ä¿å­˜...";

            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                try {
                    await db.set(DB_KEY, appData);
                    if(status) { status.innerText = "âœ… å·²ä¿å­˜"; setTimeout(() => status.innerText = "", 2000); }
                } catch (e) {
                    if(status) status.innerText = "âŒ ä¿å­˜å¤±è´¥";
                    console.error("Save failed:", e);
                }
            }, 500);
        }

        async function loadData() {
            try {
                const dbData = await db.get(DB_KEY);
                if (dbData) { appData = { ...appData, ...dbData }; }
                else {
                    const lsData = localStorage.getItem('dh_builder_v2_2') || localStorage.getItem('dh_builder_v2_1');
                    if (lsData) { try { const parsed = JSON.parse(lsData); appData = { ...appData, ...parsed }; await db.set(DB_KEY, appData); } catch(e) {} }
                }
                if(typeof appData.banner.scale === 'undefined') appData.banner.scale = 100;
                if(typeof appData.banner.visible === 'undefined') appData.banner.visible = true;
            } catch (e) { console.error("Load Error", e); }
        }

        function renderAll() {
            renderInfoPage();
            renderSessions();
            renderEncounterTOC();
            if(currentEncounterId) renderEncounterDetail(currentEncounterId);
            renderLibrary();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('page-' + tabId).classList.add('active');
            if(tabId === 'info') renderInfoPage();
            if(tabId === 'sessions') renderSessions();
            if(tabId === 'encounters') { renderEncounterTOC(); if(currentEncounterId) renderEncounterDetail(currentEncounterId); }
            if(tabId === 'cards') renderLibrary();
        }

        function toggleTheme() {
            const body = document.body;
            if(body.getAttribute('data-theme') === 'dark') body.removeAttribute('data-theme');
            else body.setAttribute('data-theme', 'dark');
        }

        // --- 1. Overview ---
        function renderInfoPage() {
            const ids = ['info-name','info-framework','info-concept','info-tone','info-themes','info-goals','info-gm','info-resources','info-platform','info-players','info-time'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                const key = id.replace('info-','');
                if(el && appData.info[key]) el.value = appData.info[key];
                if(el) el.onchange = saveData;
            });
            updateBannerUI();
        }
        function triggerBannerUpload() { document.getElementById('banner-upload-input').click(); }
        function handleBannerUpload(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    appData.banner.src = evt.target.result;
                    appData.banner.visible = true;
                    appData.banner.posX = 50; appData.banner.posY = 50; appData.banner.scale = 100;
                    updateBannerUI();
                    saveData();
                };
                reader.readAsDataURL(file);
            }
        }
        function updateBannerUI() {
            const area = document.getElementById('banner-area');
            const img = document.getElementById('banner-img-el');
            const ph = document.getElementById('banner-placeholder');
            const btn = document.getElementById('banner-toggle-btn');
            btn.textContent = appData.banner.visible ? 'ğŸ‘ï¸ éšè—æ¨ªå¹…' : 'ğŸ‘ï¸ æ˜¾ç¤ºæ¨ªå¹…';
            area.style.display = appData.banner.visible ? 'block' : 'none';
            if(appData.banner.src) {
                img.src = appData.banner.src;
                img.style.display = 'block';
                img.style.objectPosition = `${appData.banner.posX}% ${appData.banner.posY}%`;
                img.style.transform = `scale(${appData.banner.scale / 100})`;
                ph.style.display = 'none';
            } else { img.style.display = 'none'; ph.style.display = 'block'; }
        }
        function updateBannerConfig(key, val) { appData.banner[key] = val; updateBannerUI(); if(Math.random()>0.7) saveData(); }
        function toggleBannerVisibility() { appData.banner.visible = !appData.banner.visible; updateBannerUI(); saveData(); }

        // --- EXPORT FUNCTIONS ---
        function copyAnnouncement() {
            const i = appData.info;
            const text = `æ¨¡ç»„åï¼š${i.name || ''}
æˆ˜å½¹æ¡†æ¶ï¼š${i.framework || ''}
èµ„æºï¼š${i.resources || ''}
ä¸»æŒäººä¸QQå·ï¼š${i.gm || ''}
å›¢ç±»å‹ä¸å¹³å°ï¼š${i.platform || ''}
ç©å®¶äººæ•°ï¼š${i.players || ''}
å¼€å›¢æ—¶é—´ï¼š${i.time || ''}
æœ¬å›¢æ¦‚å¿µï¼š${i.concept || ''}
æœ¬å›¢ç›®æ ‡ï¼š${i.goals || ''}
æœ¬å›¢åŸºè°ƒï¼š${i.tone || ''}
æœ¬å›¢ä¸»é¢˜ï¼š${i.themes || ''}`;
            navigator.clipboard.writeText(text).then(() => showToast('âœ… å…¬å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
        }

        // --- 2. Sessions ---
        function renderSessions() {
            const toc = document.getElementById('session-toc');
            const container = document.getElementById('session-container');
            if(appData.sessions.length === 0) {
                toc.innerHTML = '<div style="padding:10px; color:var(--text-muted);">æš‚æ— ç« èŠ‚</div>';
                container.innerHTML = '<div style="text-align:center; padding:50px; color:var(--text-muted);">è¯·æ–°å»ºç« èŠ‚</div>';
                return;
            }
            toc.innerHTML = '<div class="toc-title">ç›®å½•</div>' + appData.sessions.map((s, i) => `<div class="toc-item" onclick="scrollToSession(${i})">${s.title || 'S'+(i+1)}</div>`).join('');
            container.innerHTML = appData.sessions.map((s, i) => `
                <div class="card" id="session-card-${i}">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
                         <input type="text" value="${s.title}" placeholder="ç« èŠ‚æ ‡é¢˜..." style="font-size:1.2rem; font-weight:bold; border:none; background:transparent; padding:0; flex:1;" oninput="updateSession(${i}, 'title', this.value); renderSessionsTOC();">
                         <button class="btn-text" style="color:#e53e3e;" onclick="deleteSession(${i})">ğŸ—‘ï¸</button>
                    </div>
                    <div style="display:grid; grid-template-columns: 150px 1fr; gap:15px; margin-bottom:15px;">
                        <div class="form-group" style="margin:0;"><label>æ—¥æœŸ</label><input type="date" value="${s.date}" onchange="updateSession(${i}, 'date', this.value)"></div>
                        <div class="form-group" style="margin:0;"><label>å‚å›¢ PL</label><input type="text" value="${s.pl || ''}" placeholder="Alex, Bob..." onchange="updateSession(${i}, 'pl', this.value)"></div>
                    </div>
                    <div class="form-group">
                        <label>æˆ˜æŠ¥é“¾æ¥ / å†…å®¹</label>
                        <div class="content-display" id="content-display-${i}" onclick="toggleContentEdit(${i}, true)" style="${s.content ? 'display:block' : 'display:none'}">${parseLinks(s.content)}</div>
                        <textarea id="content-edit-${i}" style="${s.content ? 'display:none' : 'display:block'}; min-height:100px;" placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹æˆ–ç²˜è´´é“¾æ¥..." onblur="toggleContentEdit(${i}, false); updateSession(${i}, 'content', this.value)">${s.content||''}</textarea>
                        <div style="font-size:0.75rem; color:var(--text-muted); margin-top:5px;">ç‚¹å‡»æ–‡æœ¬åˆ‡æ¢ç¼–è¾‘æ¨¡å¼ï¼Œè¶…é“¾æ¥å¯ç‚¹å‡»è·³è½¬ã€‚</div>
                    </div>
                </div>
            `).join('');
        }
        function parseLinks(text) { if(!text) return ''; const urlRegex = /(https?:\/\/[^\s]+)/g; return text.replace(urlRegex, '<a href="$1" target="_blank" onclick="event.stopPropagation()">$1</a>'); }
        function toggleContentEdit(idx, isEdit) {
            const display = document.getElementById(`content-display-${idx}`); const edit = document.getElementById(`content-edit-${idx}`);
            if(isEdit) { display.style.display = 'none'; edit.style.display = 'block'; edit.focus(); } 
            else { display.innerHTML = parseLinks(edit.value); display.style.display = 'block'; edit.style.display = 'none'; }
        }
        function renderSessionsTOC() { const tocItems = document.querySelectorAll('#session-toc .toc-item'); appData.sessions.forEach((s, i) => { if(tocItems[i]) tocItems[i].textContent = s.title || 'S'+(i+1); }); }
        function scrollToSession(i) { document.getElementById(`session-card-${i}`).scrollIntoView({behavior:'smooth'}); }
        function addSession() { appData.sessions.push({ title: `S${appData.sessions.length+1}: æ–°ç« èŠ‚`, date: new Date().toISOString().split('T')[0], pl: '', content: '' }); renderSessions(); saveData(); setTimeout(() => scrollToSession(appData.sessions.length - 1), 100); }
        function updateSession(i, field, val) { appData.sessions[i][field] = val; saveData(); }
        function deleteSession(i) { if(confirm('åˆ é™¤æ­¤ç« èŠ‚ï¼Ÿ')) { appData.sessions.splice(i, 1); renderSessions(); saveData(); } }

        // --- 3. Encounters ---
        function getLibItem(id) { return appData.library.find(i => i.id === id); }
        function renderEncounterTOC() {
            const c = document.getElementById('encounter-toc');
            if(appData.encounters.length === 0) { c.innerHTML = '<div style="color:var(--text-muted); font-size:0.9rem;">æš‚æ— é­é‡</div>'; return; }
            c.innerHTML = appData.encounters.map(e => `<div class="toc-item ${e.id === currentEncounterId ? 'active' : ''}" onclick="switchEncounter('${e.id}')">${e.name || 'æœªå‘½å'}</div>`).join('');
        }
        function addEncounter() { const id = Date.now().toString(); appData.encounters.push({ id, name: 'æ–°é­é‡', envId: '', notes: '', notesVisible:true, adversaries: [], countdowns: [], counters: [] }); currentEncounterId = id; saveData(); renderEncounterTOC(); renderEncounterDetail(id); }
        function switchEncounter(id) { currentEncounterId = id; renderEncounterTOC(); renderEncounterDetail(id); }

        function renderEncounterDetail(id) {
            const enc = appData.encounters.find(e => e.id === id);
            const wrapper = document.getElementById('encounter-detail-wrapper');
            const pinned = document.getElementById('pinned-cards-container');
            if(!enc) { wrapper.innerHTML = ''; return; }

            // Ensure Arrays exist (Migration safety)
            if(!enc.countdowns) enc.countdowns = [];
            if(!enc.counters) enc.counters = [];

            const sceneOpts = appData.library.filter(i=>i.type==='scene').map(s=>`<option value="${s.id}" ${s.id===enc.envId?'selected':''}>${s.data.name}</option>`).join('');

            // --- Mechanics Section ---
            let mechHTML = '';
            
            // Countdowns (V2.11 Simplified)
            enc.countdowns.forEach((cd, idx) => {
                let display = '';
                if(cd.type === 'box') {
                    // Safe guard max
                    const maxVal = parseInt(cd.max) || 4;
                    const boxes = Array(maxVal).fill(0).map((_, i) => 
                        `<div class="countdown-box ${i < cd.current ? 'filled' : ''}" onclick="updateCountdown('${id}', ${idx}, 'tickBox', ${i})"></div>`
                    ).join('');
                    display = `<div class="countdown-boxes">${boxes}</div>`;
                } else {
                    // Dice
                    const isZero = cd.current <= 0;
                    display = `<div class="countdown-die ${isZero?'zero':''}" onclick="updateCountdown('${id}', ${idx}, 'tickDie', -1)">${cd.current}</div>`;
                }

                // V2.9 New Fields
                const narrative = `
                    <div class="mech-narrative">
                        <div class="mech-input-group"><div class="mech-label">æ¿€æ´»</div><input class="mech-input" placeholder="ä½•æ—¶è§¦å‘..." value="${cd.trigger||''}" onchange="updateCountdown('${id}', ${idx}, 'trigger', this.value)"></div>
                        <div class="mech-input-group"><div class="mech-label">æ¨è¿›</div><input class="mech-input" placeholder="ä½•æ—¶å‡å°‘..." value="${cd.advance||''}" onchange="updateCountdown('${id}', ${idx}, 'advance', this.value)"></div>
                        <div class="mech-input-group"><div class="mech-label">æ•ˆæœ</div><input class="mech-input" placeholder="å½’é›¶æ—¶å‘ç”Ÿ..." value="${cd.effect||''}" onchange="updateCountdown('${id}', ${idx}, 'effect', this.value)"></div>
                    </div>
                `;

                mechHTML += `
                <div class="mech-card">
                    <button class="btn-remove-adv" style="top:5px;right:5px;font-size:1rem;" onclick="removeCountdown('${id}', ${idx})">Ã—</button>
                    <div class="mech-header">
                        <div class="mech-title"><input type="text" value="${cd.label}" onchange="updateCountdown('${id}', ${idx}, 'label', this.value)"></div>
                        <div class="mech-options">
                            <select style="border:none; background:transparent;" onchange="updateCountdown('${id}', ${idx}, 'type', this.value); renderEncounterDetail('${id}')">
                                <option value="d4" ${cd.type==='d4'?'selected':''}>D4</option>
                                <option value="d6" ${cd.type==='d6'?'selected':''}>D6</option>
                                <option value="d8" ${cd.type==='d8'?'selected':''}>D8</option>
                                <option value="d12" ${cd.type==='d12'?'selected':''}>D12</option>
                                <option value="d20" ${cd.type==='d20'?'selected':''}>D20</option>
                                <option value="box" ${cd.type==='box'?'selected':''}>æ–¹æ ¼</option>
                            </select>
                            <span>Max:</span>
                            <input type="number" class="mech-max-input" value="${cd.max}" min="1" onchange="updateCountdown('${id}', ${idx}, 'max', this.value)">
                            <span style="margin-left:5px; cursor:pointer;" onclick="updateCountdown('${id}', ${idx}, 'reset')">â†º</span>
                        </div>
                    </div>
                    <div class="mech-body">${display}</div>
                    ${narrative}
                </div>`;
            });

            // Counters
            enc.counters.forEach((cnt, idx) => {
                let display = '';
                if(cnt.style === 'dots') {
                    const dots = Array(parseInt(cnt.current)).fill(0).map(() => `<div class="counter-dot active" onclick="updateCounter('${id}', ${idx}, 'val', ${cnt.current-1})"></div>`).join('');
                    display = `<div class="counter-dots">${dots}<div class="counter-dot" style="opacity:0.3" onclick="updateCounter('${id}', ${idx}, 'val', ${cnt.current+1})">+</div></div>`;
                } else {
                    display = `<div class="counter-number" style="font-size:2rem; font-weight:bold;">${cnt.current}</div>`;
                }

                mechHTML += `
                <div class="mech-card">
                    <button class="btn-remove-adv" style="top:5px;right:5px;font-size:1rem;" onclick="removeCounter('${id}', ${idx})">Ã—</button>
                    <div class="mech-header">
                        <div class="mech-title"><input type="text" value="${cnt.label}" onchange="updateCounter('${id}', ${idx}, 'label', this.value)"></div>
                        <div class="mech-options">
                            <select style="border:none; background:transparent;" onchange="updateCounter('${id}', ${idx}, 'style', this.value); renderEncounterDetail('${id}')">
                                <option value="number" ${cnt.style==='number'?'selected':''}>æ•°å­—æ¨¡å¼</option>
                                <option value="dots" ${cnt.style==='dots'?'selected':''}>Tokenæ¨¡å¼</option>
                            </select>
                        </div>
                    </div>
                    <div class="mech-body" style="min-height:60px;">${display}</div>
                    <div class="mech-controls">
                        <div class="btn-ctrl" onclick="updateCounter('${id}', ${idx}, 'add', -1)">-</div>
                        <div class="btn-ctrl" onclick="updateCounter('${id}', ${idx}, 'add', 1)">+</div>
                    </div>
                </div>`;
            });

            // Adversaries
            let advHTML = '';
            enc.adversaries.forEach((adv, idx) => {
                const lib = getLibItem(adv.libId);
                if(!lib) return;
                const maxHp = parseInt(lib.data.health)||1;
                const maxStr = parseInt(lib.data.stress)||0;
                if(!adv.hpState) adv.hpState = Array(maxHp).fill(false);
                if(!adv.strState) adv.strState = Array(maxStr).fill(false);
                const track = (arr, type) => arr.map((chk, i) => `<div class="track-box ${chk?'checked':''}" onclick="toggleTrack('${id}',${idx},'${type}',${i})"></div>`).join('');

                advHTML += `
                <div class="adv-card">
                    <button class="btn-remove-adv" onclick="removeAdv('${id}',${idx})">Ã—</button>
                    <div class="adv-header">
                        <div class="adv-name">${lib.data.name} #${idx+1} <span class="detail-pill" onclick="showSidebar('${lib.id}')">è¯¦æƒ…</span></div>
                    </div>
                    <div class="track-row"><span class="track-label">ç”Ÿå‘½ç‚¹</span><div class="track-boxes">${track(adv.hpState, 'hpState')}</div></div>
                    ${maxStr > 0 ? `<div class="track-row"><span class="track-label str">å‹åŠ›ç‚¹</span><div class="track-boxes">${track(adv.strState, 'strState')}</div></div>` : ''}
                </div>`;
            });

            // Quick Ref
            let quickRefHTML = '';
            const uniqueAdvIds = [...new Set(enc.adversaries.map(a => a.libId))];
            uniqueAdvIds.forEach(uid => { const e = getLibItem(uid); if(e) quickRefHTML += buildStatBlock(e); });

            wrapper.innerHTML = `
                <div class="enc-header">
                    <input type="text" class="enc-title-input" value="${enc.name}" oninput="updateEnc('${id}','name',this.value);renderEncounterTOC();">
                    <div class="env-row">
                        <strong>ç¯å¢ƒ:</strong>
                        <select style="width:auto;" onchange="updateEnc('${id}','envId',this.value); renderEncounterDetail('${id}')">
                            <option value="">-- é€‰æ‹©ç¯å¢ƒ --</option>
                            ${sceneOpts}
                        </select>
                        ${enc.envId ? `<button class="env-detail-btn" onclick="showSidebar('${enc.envId}')">æŸ¥çœ‹ç¯å¢ƒè¯¦æƒ…</button>` : ''}
                        <button class="env-detail-btn" style="margin-left:auto" onclick="addCountdown('${id}')">+ å€’è®¡æ—¶</button>
                        <button class="env-detail-btn" onclick="addCounter('${id}')">+ è®¡æ•°å™¨</button>
                    </div>
                    <div class="note-wrapper">
                        <span class="note-toggle" onclick="toggleNote('${id}')">${enc.notesVisible ? 'â–¼ éšè—å¤‡æ³¨' : 'â–¶ æ˜¾ç¤ºå¤‡æ³¨'}</span>
                        <textarea class="note-box ${enc.notesVisible?'visible':''}" placeholder="åœ¨æ­¤è®°å½•é­é‡æ€è·¯..." onchange="updateEnc('${id}','notes',this.value)">${enc.notes||''}</textarea>
                    </div>
                </div>
                <div class="enc-body">
                    <div class="mechanics-grid">${mechHTML}</div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="margin:0; color:var(--text-muted);">å‚æˆ˜å•ä½</h4>
                        <button class="btn-sm" onclick="addAdvPrompt('${id}')">+ æ·»åŠ æ•Œäºº</button>
                    </div>
                    <div class="adv-grid">${advHTML || '<div style="color:var(--text-muted); font-style:italic;">æš‚æ— æ•Œäºº</div>'}</div>
                    <div class="quick-ref-area">
                        <div class="quick-ref-title"><span>ğŸ“–</span> æˆ˜æœ¯é€ŸæŸ¥</div>
                        ${quickRefHTML || '<div style="color:var(--text-muted); font-size:0.9rem;">æ·»åŠ å¡ç‰Œåè‡ªåŠ¨ç”Ÿæˆ...</div>'}
                    </div>
                    <div style="margin-top:30px; text-align:right;"><button class="btn-outline btn-sm" style="color:#e53e3e; border-color:#e53e3e;" onclick="deleteEnc('${id}')">åˆ é™¤æ­¤é­é‡</button></div>
                </div>
            `;
            renderPinned(enc, pinned);
        }

        // --- Mechanics Logic ---
        function addCountdown(id) {
            const enc = appData.encounters.find(e => e.id === id);
            enc.countdowns.push({ label: 'å€’è®¡æ—¶', type: 'd6', max: 6, current: 6, trigger:'', advance:'', effect:'' });
            saveData(); renderEncounterDetail(id);
        }
        function removeCountdown(encId, idx) {
            appData.encounters.find(e => e.id === encId).countdowns.splice(idx, 1);
            saveData(); renderEncounterDetail(encId);
        }
        function updateCountdown(encId, idx, action, val) {
            const cd = appData.encounters.find(e => e.id === encId).countdowns[idx];
            
            // Text fields
            if (action === 'label') cd.label = val;
            if (action === 'trigger') cd.trigger = val;
            if (action === 'advance') cd.advance = val;
            if (action === 'effect') cd.effect = val;
            
            // Type switching logic
            if (action === 'type') { 
                cd.type = val; 
                // Default defaults if max is not set or type implies new default
                if(val.startsWith('d')) cd.max = parseInt(val.substring(1));
                else if(val === 'box') cd.max = 4;
                else cd.max = 6;
                cd.current = cd.max;
            }

            // V2.10: Handle manual Max update
            if (action === 'max') {
                cd.max = parseInt(val);
                if (cd.current > cd.max) cd.current = cd.max;
            }

            // Ticking logic
            if (action === 'tickDie') {
                cd.current += val;
                if (cd.current < 0) cd.current = 0;
            }
            if (action === 'tickBox') {
                const newVal = val + 1;
                cd.current = (cd.current === newVal) ? newVal - 1 : newVal;
            }
            if (action === 'reset') cd.current = cd.max;
            
            saveData(); renderEncounterDetail(encId);
        }

        function addCounter(id) {
            const enc = appData.encounters.find(e => e.id === id);
            enc.counters.push({ label: 'èµ„æºç‚¹', style: 'number', current: 0 });
            saveData(); renderEncounterDetail(id);
        }
        function removeCounter(encId, idx) {
            appData.encounters.find(e => e.id === encId).counters.splice(idx, 1);
            saveData(); renderEncounterDetail(encId);
        }
        function updateCounter(encId, idx, action, val) {
            const cnt = appData.encounters.find(e => e.id === encId).counters[idx];
            if (action === 'label') cnt.label = val;
            if (action === 'style') cnt.style = val;
            if (action === 'add') cnt.current += val;
            if (action === 'val') cnt.current = val;
            if (cnt.current < 0) cnt.current = 0;
            saveData(); renderEncounterDetail(encId);
        }

        function buildStatBlock(item) {
             const d = item.data;
             let tactics = '';
             if(d.motivation) tactics = `<div class="sb-tactics"><strong>æˆ˜æœ¯/åŠ¨æœº:</strong> ${d.motivation}</div>`;
             
             return `<div class="stat-block">
                <div class="sb-header"><div>${d.name}</div><div>éš¾åº¦ ${d.difficulty}</div></div>
                <div class="sb-meta">Tier ${d.rank} ${d.type} | HP: ${d.health} | Stress: ${d.stress} | é˜ˆå€¼: ${d.threshold}</div>
                <div class="sb-row"><span class="sb-label">æ”»å‡»:</span> ${d.weaponName||'æ­¦å™¨'} (${d.weaponRange}) +${d.attackBonus} (${d.damageDice} ${d.damageType})</div>
                ${tactics}
                ${(d.traits||[]).map(t => `<div class="sb-row"><span class="sb-label">${t.name}:</span> ${t.desc}</div>`).join('')}
            </div>`;
        }

        function renderPinned(enc, container) {
            let html = '';
            if(enc.envId) { const s = getLibItem(enc.envId); if(s) html += pinnedItemHTML(s, 'åœºæ™¯'); }
            const uids = [...new Set(enc.adversaries.map(a => a.libId))];
            uids.forEach(uid => { const e = getLibItem(uid); if(e) html += pinnedItemHTML(e, 'Tier '+e.data.rank); });
            container.innerHTML = html || '<div style="color:var(--text-muted); font-size:0.9rem;">æš‚æ— å¼•ç”¨</div>';
        }

        function pinnedItemHTML(item, sub) {
            let src = '';
            if(item.type==='enemy') src = item.data.imageSrc;
            if(item.type==='scene') src = item.data.imageSettings?.src;
            if(!src || src.includes('about:blank') || src.includes('NO IMAGE')) src = '';
            return `<div class="pinned-item" onclick="showSidebar('${item.id}')">
                <div class="pinned-img">${src ? `<img src="${src}" style="width:100%; height:100%; object-fit:cover;">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${item.type==='enemy'?'ğŸ‘¹':'â›°ï¸'}</div>`}</div>
                <div style="flex:1; overflow:hidden;"><div style="font-weight:bold; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.data.name}</div><div style="font-size:0.75rem; color:var(--text-muted);">${sub}</div></div>
            </div>`;
        }

        function updateEnc(id, f, v) { appData.encounters.find(e=>e.id===id)[f]=v; saveData(); }
        function toggleNote(id) { const e = appData.encounters.find(x=>x.id===id); e.notesVisible = !e.notesVisible; saveData(); renderEncounterDetail(id); }
        function toggleTrack(eid, aid, type, box) { const e = appData.encounters.find(x=>x.id===eid); e.adversaries[aid][type][box] = !e.adversaries[aid][type][box]; saveData(); renderEncounterDetail(eid); }
        function removeAdv(eid, idx) { appData.encounters.find(x=>x.id===eid).adversaries.splice(idx,1); saveData(); renderEncounterDetail(eid); }
        function deleteEnc(id) { if(confirm('åˆ é™¤æ­¤é­é‡ï¼Ÿ')) { appData.encounters = appData.encounters.filter(e=>e.id!==id); currentEncounterId = null; saveData(); renderEncounterTOC(); document.getElementById('encounter-detail-wrapper').innerHTML = ''; }}
        function addAdvPrompt(eid) {
            const enemies = appData.library.filter(i=>i.type==='enemy');
            if(enemies.length===0) return alert('åº“ä¸­æ— æ•Œäººï¼Œè¯·å…ˆå¯¼å…¥ï¼');
            const div = document.createElement('div');
            div.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:200;display:flex;justify-content:center;align-items:center;";
            const opts = enemies.map(e=>`<option value="${e.id}">${e.data.name}</option>`).join('');
            div.innerHTML = `<div class="card" style="width:300px;"><h3>æ·»åŠ æ•Œäºº</h3><select id="tmp-sel" style="margin-bottom:15px;">${opts}</select><div style="display:flex; gap:10px;"><input type="number" id="tmp-cnt" value="1" min="1" style="width:60px;"><button class="btn" id="tmp-ok">ç¡®å®š</button><button class="btn-outline" onclick="this.closest('div').parentNode.remove()">å–æ¶ˆ</button></div></div>`;
            document.body.appendChild(div);
            document.getElementById('tmp-ok').onclick = () => {
                const libId = document.getElementById('tmp-sel').value;
                const cnt = parseInt(document.getElementById('tmp-cnt').value);
                const enc = appData.encounters.find(e=>e.id===eid);
                for(let i=0; i<cnt; i++) enc.adversaries.push({libId, hpState:null, strState:null});
                saveData(); renderEncounterDetail(eid); div.remove();
            }
        }

        // --- 4. Library ---
        function importJSON(input) {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const raw = JSON.parse(e.target.result);
                    const list = Array.isArray(raw) ? raw : [raw];
                    list.forEach(j => {
                        let type = (j.health!==undefined||j.threshold!==undefined) ? 'enemy' : 'scene';
                        appData.library.push({ id: Date.now().toString(36)+Math.random().toString(36).substr(2), type, data: j, isFav: false });
                    });
                    saveData(); renderLibrary(); alert('å¯¼å…¥æˆåŠŸ');
                } catch(err) { alert('JSONé”™è¯¯'); }
            };
            r.readAsText(file); input.value = '';
        }
        function renderLibrary() {
            const term = document.getElementById('lib-search').value.toLowerCase();
            const list = appData.library.filter(i => (i.data.name||'').toLowerCase().includes(term));
            const scenes = list.filter(i => i.type === 'scene');
            const enemies = list.filter(i => i.type === 'enemy');
            let html = '';
            if (list.length === 0) html = '<div style="text-align:center; padding:40px; color:var(--text-muted);">æœªæ‰¾åˆ°å¡ç‰‡ï¼Œè¯·å¯¼å…¥JSONæ–‡ä»¶ã€‚</div>';
            else { 
                if(scenes.length>0) html += `<h3 style="margin: 20px 0 15px 0; color:var(--text-muted); font-family:'Oswald',sans-serif; display:flex; align-items:center; gap:8px; border-bottom:1px solid var(--border-color); padding-bottom:5px;">â›°ï¸ åœºæ™¯</h3><div class="lib-grid">${scenes.map(i=>renderLibCard(i)).join('')}</div>`;
                if(enemies.length>0) html += `<h3 style="margin: 20px 0 15px 0; color:var(--text-muted); font-family:'Oswald',sans-serif; display:flex; align-items:center; gap:8px; border-bottom:1px solid var(--border-color); padding-bottom:5px;">ğŸ‘¹ æ•Œäºº</h3><div class="lib-grid">${enemies.map(i=>renderLibCard(i)).join('')}</div>`;
            }
            document.getElementById('library-content').innerHTML = html;
        }
        function renderLibCard(item) {
            let src = '';
            if(item.type==='enemy') src = item.data.imageSrc;
            if(item.type==='scene') src = item.data.imageSettings?.src;
            if(!src || src.includes('about:blank') || src.includes('NO IMAGE')) src = '';
            return `<div class="lib-card" onclick="showSidebar('${item.id}')">
                <div class="lib-fav-icon ${item.isFav?'active':''}" onclick="toggleFav('${item.id}');event.stopPropagation();">â¤</div>
                <div class="lib-img">${src ? `<img src="${src}">` : `<span style="font-size:2rem; opacity:0.3;">${item.type==='enemy'?'ğŸ‘¹':'â›°ï¸'}</span>`}</div>
                <div style="padding:10px; text-align:center;"><div style="font-weight:bold; font-size:0.9rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.data.name}</div><div style="font-size:0.75rem; color:var(--text-muted);">T${item.data.rank}</div></div>
            </div>`;
        }
        function toggleFav(id) { const i = appData.library.find(x=>x.id===id); if(i) { i.isFav = !i.isFav; saveData(); renderLibrary(); } }

        // --- Sidebar ---
        function showSidebar(id) {
            const item = appData.library.find(i=>i.id===id);
            if(!item) return;
            const d = item.data;
            const md = t => (t||'').replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/==(.*?)==/g,'<span style="color:var(--accent-color); background:rgba(224,93,68,0.1);">$1</span>');
            
            let html = `<h2 style="font-family:'Oswald',sans-serif; color:var(--accent-color); border-bottom:2px solid var(--accent-color); padding-bottom:10px;">${d.name}</h2>`;
            if(item.type==='enemy') {
                html += `<p>Tier ${d.rank} ${d.type} | éš¾åº¦ ${d.difficulty} | é˜ˆå€¼ ${d.threshold}</p>
                <div style="background:var(--track-empty); padding:10px; border-radius:6px; margin-bottom:15px;"><strong>${d.weaponName||'Weapon'}</strong> (${d.weaponRange}): +${d.attackBonus} (${d.damageDice} ${d.damageType})</div>
                <p>${md(d.description)}</p>
                <p><strong>åŠ¨æœº:</strong> ${md(d.motivation)}</p>
                <h4>ç‰¹æ€§</h4>${(d.traits||[]).map(t=>`<div style="margin-bottom:8px;"><strong>${t.name}:</strong> ${md(t.desc)}</div>`).join('')}`;
            } else {
                html += `<p>Tier ${d.rank} ${d.type} | éš¾åº¦ ${d.difficulty}</p><p>${md(d.description)}</p><h4>ç‰¹æ€§</h4>${(d.traits||[]).map(t=>`<div style="margin-bottom:8px;"><strong>${t.name}</strong> (${t.type}): ${md(t.desc)}</div>`).join('')}`;
            }
            
            let img = '';
            if(item.type==='enemy') img = d.imageSrc;
            if(item.type==='scene') img = d.imageSettings?.src;
            if(img && !img.includes('about:blank') && !img.includes('NO IMAGE')) html += `<img src="${img}" style="width:100%; margin-top:20px; border-radius:8px;">`;
            html += `<div style="margin-top:40px; text-align:right;"><button class="btn-sm btn-outline" style="color:#e53e3e; border-color:#e53e3e;" onclick="if(confirm('åˆ é™¤?')) { appData.library=appData.library.filter(x=>x.id!=='${id}'); saveData(); renderLibrary(); closeSidebar(); }">åˆ é™¤å¡ç‰‡</button></div>`;

            document.getElementById('ds-content').innerHTML = html;
            document.querySelector('.sidebar-overlay').classList.add('active');
            document.getElementById('detail-sidebar').classList.add('active');
        }
        function closeSidebar() { document.querySelector('.sidebar-overlay').classList.remove('active'); document.getElementById('detail-sidebar').classList.remove('active'); }

        function showToast(msg, autoHide = true) {
            document.querySelectorAll('.app-toast').forEach(e => e.remove());
            const div = document.createElement('div');
            div.className = 'app-toast';
            div.style.cssText = `position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:rgba(30, 41, 59, 0.95); color:white; padding:10px 20px; border-radius:30px; z-index:200; animation:fadeIn 0.3s; font-size:0.9rem; box-shadow:0 5px 15px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1);`;
            div.textContent = msg;
            document.body.appendChild(div);
            if(autoHide) setTimeout(() => div.remove(), 2500);
            return autoHide ? null : div;
        }
    </script>
</body>
</html>